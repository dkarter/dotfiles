# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

vars:
  GH_PLUGINS:
    - 'dlvhdr/gh-dash'
    - 'meiji163/gh-notify'

tasks:
  automerge:renovate:
    desc: Auto merges all PRs
    summary: |
      Auto merges all PRs

      Does the following:
      - sets PRs to auto merge
      - uses squash to merge
      - automatically delete the branch after merge
    silent: true
    cmd: |
      gh pr list --state open --author 'app/renovate' | awk '{ print $1 }' | xargs -I{} gh pr merge {} --auto --squash --delete-branch

  plugins:install:
    desc: Install Github CLI plugins
    cmds:
      - for:
          var: GH_PLUGINS
          as: PLUGIN
        cmd: gh extension install {{.PLUGIN}}
        silent: true

  plugins:update:
    desc: Update Github CLI plugins
    cmds:
      - for:
          var: GH_PLUGINS
          as: PLUGIN
        cmd: gh extension upgrade {{.PLUGIN}}
        silent: true

  release:
    desc: Merges the release PR
    summary: |
      Merges the release PR which:
      - bumps the version
      - updates the changelog
      - creates a github release
    silent: true
    cmd: |
      PR_NUMBER=$(gh pr list --state open --label "autorelease: pending" --author "@me" --json number --jq '.[0].number')
      if [ -n "$PR_NUMBER" ]; then
        echo "Merging release PR #$PR_NUMBER"
        gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
      else
        echo "No release PR found"
        exit 1
      fi

  sync:
    desc: Synchronize gh plugins
    cmds:
      - task: plugins:install
      - task: plugins:update
